#!/usr/bin/env bash
set -euo pipefail

repo_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

os="$(uname -s | tr '[:upper:]' '[:lower:]')"

ok() { printf "ok   %s\n" "$*"; }
warn() { printf "warn %s\n" "$*"; }
bad() { printf "bad  %s\n" "$*"; }

have() { command -v "$1" >/dev/null 2>&1; }

echo "dotfiles doctor"
echo "- repo: $repo_root"
echo "- os:   $os"

echo
echo "core"
have git && ok "git" || bad "git (required)"
have stow && ok "stow" || bad "stow (required)"

echo
echo "oh-my-zsh"
if [[ -d "$HOME/.oh-my-zsh" ]]; then
  ok "~/.oh-my-zsh exists"
else
  warn "~/.oh-my-zsh missing (run ./script/bootstrap)"
fi

zsh_custom="${XDG_CONFIG_HOME:-$HOME/.config}/oh-my-zsh"
if [[ -d "$zsh_custom" ]]; then
  ok "ZSH_CUSTOM dir: $zsh_custom"
else
  warn "ZSH_CUSTOM dir missing: $zsh_custom (run ./script/bootstrap)"
fi

if [[ -f "$zsh_custom/themes/adrien-agnoster.zsh-theme" ]]; then
  ok "custom theme installed"
else
  warn "custom theme missing (stow oh-my-zsh-custom)"
fi

echo
echo "zsh extras (optional)"
zsh_plugin_dir="${XDG_DATA_HOME:-$HOME/.local/share}/zsh/plugins"
[[ -d "$zsh_plugin_dir/zsh-autosuggestions" ]] && ok "zsh-autosuggestions" || warn "zsh-autosuggestions (run ./script/bootstrap)"
[[ -d "$zsh_plugin_dir/fast-syntax-highlighting" ]] && ok "fast-syntax-highlighting" || warn "fast-syntax-highlighting (run ./script/bootstrap)"
[[ -d "$zsh_plugin_dir/fzf-tab" ]] && ok "fzf-tab" || warn "fzf-tab (run ./script/bootstrap)"

echo
echo "python (optional)"
if have pyenv; then
  if pyenv commands 2>/dev/null | command grep -qx "virtualenv-init"; then
    ok "pyenv-virtualenv available"
  else
    warn "pyenv-virtualenv missing (run ./script/install or install plugin)"
  fi
else
  warn "pyenv"
fi

echo
echo "cli tools (recommended)"
if have fzf; then ok "fzf"; else warn "fzf"; fi
if have rg; then ok "rg"; else warn "rg"; fi
if have fd || have fdfind; then ok "fd"; else warn "fd"; fi
if have bat || have batcat; then ok "bat"; else warn "bat"; fi
if have kitty; then ok "kitty"; else warn "kitty"; fi
if have nvim; then ok "nvim"; else warn "nvim"; fi
if have opencode; then ok "opencode"; else warn "opencode"; fi

echo
echo "neovim"
if [[ -f "$repo_root/config/.config/nvim/lazy-lock.json" ]]; then
  ok "lazy-lock.json committed"
else
  warn "lazy-lock.json missing"
fi

echo
echo "opencode"
opencode_state_dir="$HOME/.local/state/opencode"
have opencode && ok "opencode" || warn "opencode (run ./script/install)"

if [[ -f "$repo_root/opencode-state/.local/state/opencode/kv.json" ]]; then
  if [[ -L "$opencode_state_dir/kv.json" ]]; then
    warn "kv.json is a symlink (run ./script/bootstrap to migrate)"
  elif [[ -f "$opencode_state_dir/kv.json" ]]; then
    ok "kv.json present"
  else
    warn "kv.json missing (run ./script/bootstrap)"
  fi
fi

if [[ -f "$repo_root/opencode-state/.local/state/opencode/model.json" ]]; then
  if [[ -L "$opencode_state_dir/model.json" ]]; then
    warn "model.json is a symlink (run ./script/bootstrap to migrate)"
  elif [[ -f "$opencode_state_dir/model.json" ]]; then
    ok "model.json present"
  else
    warn "model.json missing (run ./script/bootstrap)"
  fi
fi

echo
echo "install hints"
echo "- dotfiles: $repo_root/script/install"
case "$os" in
  linux)
    echo "- Debian/Ubuntu: sudo apt install -y stow git zsh fzf ripgrep fd-find bat"
    echo "  (fd may be 'fdfind', bat may be 'batcat')"
    ;;
  darwin)
    echo "- macOS (Homebrew): brew install stow git zsh fzf ripgrep fd bat"
    ;;
  *)
    echo "- install: stow git zsh fzf ripgrep fd bat"
    ;;
esac
